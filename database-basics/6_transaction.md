# 6. トランザクションとACID特性

# 6.1. トランザクションとは何か
### 処理の「All or Nothing」を保証する論理的な作業単位
トランザクションとは、データベースに対する一連の操作（一つ以上のSQL文）をひとまとめにした、論理的な処理単位のことです 。
トランザクションの最も重要な特性は「原子性（Atomicity）」であり、これは「All or Nothing（すべて実行されるか、一切実行されないか）」の原則を保証することを意味します 。
つまり、トランザクションに含まれる全ての操作が成功した場合にのみ、その結果がデータベースに恒久的に保存されます。
もし一連の操作の途中で何らかのエラーや障害が発生した場合は、それまでに行われた全ての操作が取り消され、データベースはトランザクションが開始される前の状態に完全に戻されます。
この仕組みにより、中途半端な更新処理によってデータが矛盾した状態に陥ることを防ぎます。

### 具体例：銀行振込処理の舞台裏
トランザクションの概念を具体的に理解するために、銀行の口座振込処理を考えてみましょう。
Aさんの口座からBさんの口座へ1万円を送金する場合、システム内部では少なくとも以下の二つの操作が必要です。   

1.Aさんの口座残高から1万円を減らす（UPDATE文）

2.Bさんの口座残高に1万円を加算する（UPDATE文）

もし、1の処理が成功した直後にシステム障害が発生し、2の処理が実行されなかった場合、Aさんの口座から1万円が消えたにもかかわらず、Bさんの口座には入金されません。
これは、全体として1万円が消失したことを意味し、データの整合性が完全に崩壊した状態です。
しかし、これら二つの操作を一つのトランザクションとしてまとめることで、DBMSはその「All or Nothing」を保証します。
障害が発生すれば、Aさんの口座から1万円を減らす操作も自動的に取り消され、お金が消えるという事態を防ぐことができるのです。
このようにトランザクションは、現実世界のビジネスルールをデータベース上で安全に実現するための不可欠な仕組みです。

<img width="846" height="616" alt="スクリーンショット 2025-08-17 21 32 23" src="https://github.com/user-attachments/assets/598d0b2d-a811-4b80-baa2-01a567d1a46b" />

### COMMIT と ROLLBACK 変更の確定と破棄
トランザクションのライフサイクルは、二つの基本的なコマンドによって制御されます。

COMMIT: トランザクション内の全ての操作が正常に完了したことを宣言し、その変更をデータベースに恒久的に反映させる命令です。COMMITが実行されると、変更内容は確定し、他のトランザクションからも参照可能になります 。   

ROLLBACK: トランザクション内でエラーが発生した場合や、処理を意図的に中断したい場合に、それまでに行った全ての変更を破棄し、データベースをトランザクション開始前の状態に戻す命令です 。これが「Nothing」の部分を強制するメカニズムです。   

開発者は、一連のビジネスロジックの成功をもってCOMMITを実行し、途中で問題が検知された場合にはROLLBACKを実行することで、データの整合性を能動的に管理します。

# 6.1. トランザクションとは何か
トランザクションがデータベースの信頼性を保証するために備えるべき4つの重要な性質は、それぞれの頭文字をとってACID特性と呼ばれます。
これらの特性は、データベースシステムが予期せぬ障害やエラーに直面しても、データの完全性を維持するための基盤となります 。
ここでは、料理教室の例えを用いて直感的なイメージを掴んだ後、各特性を技術的に詳述します 。   

- 原子性 (Atomicity): レシピの全工程を完璧にこなすこと。途中で失敗したら最初からやり直し。

- 一貫性 (Consistency): 教室のルール（アレルギー食材は使わない等）を常に守ること。

- 独立性 (Isolation): 他の生徒の作業が自分の料理に影響を与えないこと。

- 永続性 (Durability): 完成した料理を冷蔵庫にしっかり保存し、失われないようにすること。

## 6.2.1 Atomicity (原子性): 不可分な操作
- 定義と技術的実現:
  原子性とは、前述の通りトランザクションが「All or Nothing」で実行されることを保証する性質です。
  技術的には、これは主にトランザクションログを用いて実現されます。
  データベース本体のデータを直接変更する前に、まず「これからどのような変更を行うか」という操作内容をログファイルに記録します。
  もしトランザクションが中断（アボート）された場合、DBMSはこのログを逆方向に辿り、実行された操作を取り消す（UNDO）ことで、データベースを矛盾のない状態に戻します 。   

- シナリオ(原子性が失われた場合の問題点)
  銀行振込の例で原子性が保証されない場合、送金元口座からの引き落としは完了したが、システムクラッシュにより送金先口座への入金が行われない、という事態が発生します。
  結果として、顧客の資産が失われ、データベースは不整合な状態に陥ります。
  原子性は、トランザクションにおける整合性の最も基本的な保証です。   





